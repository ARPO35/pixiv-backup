<%+header%>
<h2><%:Pixiv备份状态%></h2>

<div class="cbi-section">
    <div class="table">
        <div class="tr">
            <div class="td"><%:服务状态%></div>
            <div class="td" id="service-status">
                <img src="<%=resource%>/icons/loading.gif" alt="<%:加载中%>">
            </div>
        </div>
        <div class="tr">
            <div class="td"><%:配置状态%></div>
            <div class="td" id="config-status">
                <img src="<%=resource%>/icons/loading.gif" alt="<%:加载中%>">
            </div>
        </div>
        <div class="tr">
            <div class="td"><%:最后运行时间%></div>
            <div class="td" id="last-run">
                <img src="<%=resource%>/icons/loading.gif" alt="<%:加载中%>">
            </div>
        </div>
        <div class="tr">
            <div class="td"><%:已下载作品%></div>
            <div class="td" id="total-downloaded">
                <img src="<%=resource%>/icons/loading.gif" alt="<%:加载中%>">
            </div>
        </div>
        <div class="tr">
            <div class="td"><%:存储使用%></div>
            <div class="td" id="storage-used">
                <img src="<%=resource%>/icons/loading.gif" alt="<%:加载中%>">
            </div>
        </div>
    </div>
</div>

<h2><%:操作%></h2>
<div class="cbi-section">
    <div class="table">
        <div class="tr">
            <div class="td">
                <button class="btn cbi-button cbi-button-apply" onclick="startService()">
                    <%:开始备份%>
                </button>
                <button class="btn cbi-button cbi-button-reset" onclick="stopService()">
                    <%:停止备份%>
                </button>
                <button class="btn cbi-button cbi-button-link" onclick="viewLogs()">
                    <%:查看日志%>
                </button>
            </div>
        </div>
    </div>
</div>

<h2><%:实时日志%></h2>
<div class="cbi-section">
    <textarea id="log-content" rows="20" style="width: 100%; font-family: monospace;" readonly></textarea>
    <div class="tr">
        <div class="td">
            <button class="btn cbi-button cbi-button-action" onclick="refreshLogs()">
                <%:刷新日志%>
            </button>
            <button class="btn cbi-button cbi-button-link" onclick="clearLogs()">
                <%:清除日志%>
            </button>
        </div>
    </div>
</div>

<script>
// 更新状态信息
function updateStatus() {
    fetch('<%=luci.dispatcher.build_url("admin/services/pixiv-backup/status")%>')
        .then(response => response.json())
        .then(data => {
            document.getElementById('service-status').innerHTML = 
                data.service_status === 'running' ? 
                '<span style="color: green">● 运行中</span>' : 
                '<span style="color: red">● 已停止</span>';
            
            document.getElementById('config-status').innerHTML = 
                data.config_status === 'configured' ? 
                '<span style="color: green">● 已配置</span>' : 
                '<span style="color: orange">● 未配置</span>';
            
            document.getElementById('last-run').textContent = 
                data.last_run ? data.last_run : '从未运行';
            
            document.getElementById('total-downloaded').textContent = 
                data.stats.total_downloaded + ' 作品';
            
            document.getElementById('storage-used').textContent = 
                data.stats.storage_used;
        })
        .catch(error => {
            console.error('获取状态失败:', error);
        });
}

// 开始服务
function startService() {
    fetch('<%=luci.dispatcher.build_url("admin/services/pixiv-backup/start")%>')
        .then(response => response.text())
        .then(result => {
            alert('开始备份: ' + result);
            updateStatus();
        })
        .catch(error => {
            alert('启动失败: ' + error);
        });
}

// 停止服务
function stopService() {
    fetch('<%=luci.dispatcher.build_url("admin/services/pixiv-backup/stop")%>')
        .then(response => response.text())
        .then(result => {
            alert('停止备份: ' + result);
            updateStatus();
        })
        .catch(error => {
            alert('停止失败: ' + error);
        });
}

// 查看日志
function viewLogs() {
    fetch('<%=luci.dispatcher.build_url("admin/services/pixiv-backup/logs")%>')
        .then(response => response.text())
        .then(logs => {
            document.getElementById('log-content').value = logs;
        })
        .catch(error => {
            document.getElementById('log-content').value = '无法读取日志: ' + error;
        });
}

// 刷新日志
function refreshLogs() {
    viewLogs();
}

// 清除日志
function clearLogs() {
    if (confirm('确定要清除日志吗？')) {
        document.getElementById('log-content').value = '';
    }
}

// 页面加载时初始化
window.onload = function() {
    updateStatus();
    viewLogs();
    // 每30秒更新一次状态
    setInterval(updateStatus, 30000);
};
</script>

<%+footer%>